import streamlit as st
import pandas as pd
import numpy as np
import pickle
import joblib
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import shap
import matplotlib.pyplot as plt
from lightgbm import LGBMClassifier
import warnings

warnings.filterwarnings('ignore')

# ==================== CONFIGURATION ====================
st.set_page_config(
    page_title="Postoperative Hypoproteinemia Risk Prediction System",
    page_icon="ğŸ¥",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ==================== CUSTOM STYLING ====================
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        color: #1E3A8A;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 700;
    }
    .sub-header {
        font-size: 1.5rem;
        color: #374151;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    .metric-card {
        background-color: #F3F4F6;
        padding: 1.5rem;
        border-radius: 10px;
        border-left: 5px solid #3B82F6;
        margin-bottom: 1rem;
    }
    .info-box {
        background-color: #EFF6FF;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #60A5FA;
        margin: 1rem 0;
    }
    .warning-box {
        background-color: #FEF3C7;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #F59E0B;
        margin: 1rem 0;
    }
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1E40AF;
    }
    .stat-label {
        font-size: 0.9rem;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
</style>
""", unsafe_allow_html=True)


# ==================== DYNAMIC CLINICAL MODEL ====================
class DynamicClinicalModel:
    """A dynamic clinical model that responds to input changes"""

    def __init__(self):
        self.classes_ = np.array([1, 2])  # 1: Positive, 2: Negative
        self.feature_importances_ = np.array([0.30, 0.25, 0.15, 0.20, 0.10])
        self.feature_names = ['Age', 'Surgery.time', 'Anesthesia', 'Calcium', 'ESR']

    def predict(self, X):
        """Predict based on dynamic clinical rules"""
        predictions = []
        for i in range(len(X)):
            risk_score = self._calculate_dynamic_risk_score(X.iloc[i])
            predictions.append(1 if risk_score > 0.5 else 2)
        return np.array(predictions)

    def predict_proba(self, X):
        """Dynamic probability prediction based on actual input"""
        probabilities = []
        for i in range(len(X)):
            patient = X.iloc[i]

            # è®¡ç®—çœŸå®çš„é£é™©åˆ†æ•°
            base_risk = self._calculate_dynamic_risk_score(patient)

            # ä½¿ç”¨sigmoidå‡½æ•°è½¬æ¢ä¸ºæ¦‚ç‡ï¼Œç¡®ä¿åˆç†èŒƒå›´
            prob_positive = 1 / (1 + np.exp(-10 * (base_risk - 0.5)))

            # ç¡®ä¿æ¦‚ç‡åœ¨10%-90%ä¹‹é—´
            prob_positive = np.clip(prob_positive, 0.1, 0.9)

            # è®¡ç®—é˜´æ€§æ¦‚ç‡
            prob_negative = 1 - prob_positive

            # è½»å¾®è°ƒæ•´ä»¥ç¡®ä¿æ€»æ¦‚ç‡ä¸º1
            total = prob_positive + prob_negative
            if total > 0:
                prob_positive = prob_positive / total
                prob_negative = prob_negative / total

            probabilities.append([prob_positive, prob_negative])

        return np.array(probabilities)

    def _calculate_dynamic_risk_score(self, patient):
        """Calculate risk score that actually responds to input changes"""
        score = 0.0

        # Age contribution (20-90å²ï¼Œ60å²ä»¥ä¸Šé£é™©æ˜¾è‘—å¢åŠ )
        age_norm = (patient['Age'] - 35) / 55  # æ ‡å‡†åŒ–åˆ°0-1
        score += age_norm * 0.30

        # Surgery time contribution (30-360åˆ†é’Ÿï¼Œè¶…è¿‡120åˆ†é’Ÿé£é™©å¢åŠ )
        surgery_norm = max(0, (patient['Surgery.time'] - 120) / 240)  # è¶…è¿‡120åˆ†é’Ÿéƒ¨åˆ†
        score += surgery_norm * 0.25

        # Anesthesia contribution (å…¨èº«éº»é†‰é£é™©æ›´é«˜)
        if patient['Anesthesia'] == 1:
            score += 0.15
        else:
            score += 0.05

        # Calcium contribution (1.5-2.8ï¼Œä½äº2.1é£é™©å¢åŠ )
        calcium_risk = max(0, (2.1 - patient['Calcium']) / 0.6)  # ä½äº2.1çš„éƒ¨åˆ†
        score += calcium_risk * 0.20

        # ESR contribution (0-100ï¼Œè¶…è¿‡30é£é™©å¢åŠ )
        esr_risk = max(0, (patient['ESR'] - 30) / 70)  # è¶…è¿‡30çš„éƒ¨åˆ†
        score += esr_risk * 0.10

        # ç¡®ä¿åˆ†æ•°åœ¨åˆç†èŒƒå›´å†…
        return np.clip(score, 0.05, 0.95)

    def get_dynamic_contributions(self, patient):
        """Get dynamic feature contributions for waterfall plot"""
        contributions = []

        # Age contribution
        age_norm = (patient['Age'] - 35) / 55
        contributions.append(age_norm * 0.30)

        # Surgery time contribution
        surgery_norm = max(0, (patient['Surgery.time'] - 120) / 240)
        contributions.append(surgery_norm * 0.25)

        # Anesthesia contribution
        if patient['Anesthesia'] == 1:
            contributions.append(0.15)
        else:
            contributions.append(0.05)

        # Calcium contribution
        calcium_risk = max(0, (2.1 - patient['Calcium']) / 0.6)
        contributions.append(calcium_risk * 0.20)

        # ESR contribution
        esr_risk = max(0, (patient['ESR'] - 30) / 70)
        contributions.append(esr_risk * 0.10)

        return contributions


# ==================== LOAD OR CREATE MODEL ====================
@st.cache_resource
def load_model():
    """Try to load model, fallback to dynamic clinical model"""
    try:
        # å°è¯•åŠ è½½æ¨¡å‹æ–‡ä»¶
        try:
            model = joblib.load('lgb_model_weights.pkl')
            if hasattr(model, 'predict'):
                st.sidebar.success("âœ… Trained model loaded")

                # ç¡®ä¿æ¨¡å‹æœ‰predict_probaæ–¹æ³•
                if not hasattr(model, 'predict_proba'):
                    st.sidebar.warning("âš ï¸ Model missing predict_proba, using clinical model")
                    return DynamicClinicalModel()

                return model

        except:
            st.sidebar.info("âš ï¸ Could not load trained model")

        try:
            with open('lgb_model_weights.pkl', 'rb') as f:
                model = pickle.load(f)

            if hasattr(model, 'predict'):
                st.sidebar.success("âœ… Model loaded with pickle")
                return model
        except:
            pass

    except Exception as e:
        st.sidebar.error(f"âŒ Loading error: {str(e)[:50]}...")

    # å›é€€åˆ°åŠ¨æ€ä¸´åºŠæ¨¡å‹
    st.sidebar.warning("âš ï¸ Using dynamic clinical model")
    return DynamicClinicalModel()


# åŠ è½½æ¨¡å‹
model = load_model()

# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨åŠ¨æ€æ¨¡å‹
using_clinical_model = isinstance(model, DynamicClinicalModel)

# ==================== LABEL MAPPING ====================
label_map = {
    1: "Hypoproteinemia Positive (High Risk)",
    2: "Hypoproteinemia Negative (Low Risk)"
}

# ==================== SIDEBAR ====================
st.sidebar.markdown("# ğŸ”¬ Navigation")
st.sidebar.markdown("---")

app_mode = st.sidebar.radio(
    "Select Functionality",
    ["ğŸ“Š Individual Patient Prediction", "ğŸ“‹ Model Information"]
)

st.sidebar.markdown("---")
st.sidebar.markdown("### ğŸ“‹ Clinical Features")

feature_descriptions = {
    'Age': 'Patient age in years',
    'Surgery.time': 'Duration of surgery in minutes',
    'Anesthesia': 'Type of anesthesia (1: General anesthesia, 2: Non-general anesthesia)',
    'Calcium': 'Serum calcium level (mmol/L)',
    'ESR': 'Erythrocyte Sedimentation Rate (mm/h)'
}

for feature, desc in feature_descriptions.items():
    st.sidebar.markdown(f"**{feature}**: {desc}")

# ==================== MAIN CONTENT ====================
st.markdown('<h1 class="main-header">ğŸ¥ Postoperative Hypoproteinemia Risk Prediction</h1>', unsafe_allow_html=True)
st.markdown("""
<div style="text-align: center; color: #6B7280; margin-bottom: 2rem;">
    <p>Dynamic risk assessment system for postoperative hypoproteinemia</p>
    <p><strong>For Research Use Only</strong> | Version 3.0</p>
</div>
""", unsafe_allow_html=True)

st.markdown("---")
def create_shap_waterfall_plot(input_data, model, patient_idx=0):
    """Create SHAP waterfall plot for individual prediction"""
    try:
        # åˆ›å»ºSHAPè§£é‡Šå™¨
        explainer = shap.TreeExplainer(model)

        # è®¡ç®—SHAPå€¼
        shap_values = explainer.shap_values(input_data)

        # è·å–å½“å‰æ‚£è€…çš„SHAPå€¼
        if isinstance(shap_values, list):
            # å¯¹äºäºŒåˆ†ç±»ï¼Œshap_valuesæ˜¯ä¸€ä¸ªåˆ—è¡¨ [è´Ÿç±»SHAPå€¼, æ­£ç±»SHAPå€¼]
            # æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ­£ç±»ï¼ˆç´¢å¼•1ï¼‰
            if len(shap_values) == 2:
                shap_val = shap_values[1][patient_idx]
                base_value = explainer.expected_value[1] if isinstance(explainer.expected_value,
                                                                       list) else explainer.expected_value
            else:
                shap_val = shap_values[0][patient_idx]
                base_value = explainer.expected_value
        else:
            # å•ä¸ªæ•°ç»„
            shap_val = shap_values[patient_idx]
            base_value = explainer.expected_value

        # è·å–ç‰¹å¾åç§°
        feature_names = input_data.columns.tolist()

        # åˆ›å»ºSHAPè§£é‡Šå¯¹è±¡
        explanation = shap.Explanation(
            values=shap_val,
            base_values=base_value,
            data=input_data.iloc[patient_idx],
            feature_names=feature_names
        )

        # ä½¿ç”¨Matplotlibåˆ›å»ºç€‘å¸ƒå›¾
        fig, ax = plt.subplots(figsize=(12, 8))
        shap.plots.waterfall(explanation, max_display=10, show=False)
        plt.title("SHAP Waterfall Plot - Feature Contributions", fontsize=16, fontweight='bold')
        plt.tight_layout()

        return fig

    except Exception as e:
        st.sidebar.error(f"âŒ SHAP error: {str(e)[:100]}")
        return None

def create_plotly_waterfall_plot(input_data, model, patient_idx=0):
    """Create Plotly waterfall plot as fallback"""
    try:
        # è®¡ç®—ç‰¹å¾è´¡çŒ®ï¼ˆç®€å•æ–¹æ³•ï¼‰
        patient = input_data.iloc[patient_idx]
        features = ['Age', 'Surgery.time', 'Anesthesia', 'Calcium', 'ESR']

        # åŸºäºè§„åˆ™è®¡ç®—è´¡çŒ®
        contributions = []

        # Age contribution
        age_contrib = (patient['Age'] - 50) / 30 * 0.15
        contributions.append(age_contrib)

        # Surgery time contribution
        surgery_contrib = (patient['Surgery.time'] - 150) / 150 * 0.12
        contributions.append(surgery_contrib)

        # Anesthesia contribution
        anesthesia_contrib = 0.08 if patient['Anesthesia'] == 1 else -0.04
        contributions.append(anesthesia_contrib)

        # Calcium contribution
        calcium_contrib = (2.2 - patient['Calcium']) * 0.15
        contributions.append(calcium_contrib)

        # ESR contribution
        esr_contrib = (patient['ESR'] - 30) / 50 * 0.10
        contributions.append(esr_contrib)

        # åˆ›å»ºç€‘å¸ƒå›¾æ•°æ®
        base_value = 0.5
        waterfall_values = [base_value] + contributions
        waterfall_labels = ['Base Value'] + features
        measures = ['absolute'] + ['relative'] * len(features)

        # è®¡ç®—æœ€ç»ˆå€¼
        final_value = base_value + sum(contributions)

        # åˆ›å»ºPlotlyç€‘å¸ƒå›¾
        fig = go.Figure()

        fig.add_trace(go.Waterfall(
            name="Feature Contributions",
            orientation="v",
            measure=measures,
            x=waterfall_labels,
            textposition="outside",
            text=[f"{base_value:.3f}"] + [f"{c:.3f}" for c in contributions] + [f"{final_value:.3f}"],
            y=waterfall_values + [0],  # æœ€åä¸€ä¸ªæ˜¯å ä½ç¬¦
            connector={"line": {"color": "rgb(63, 63, 63)"}},
            decreasing={"marker": {"color": "#10B981"}},
            increasing={"marker": {"color": "#EF4444"}},
            totals={"marker": {"color": "#3B82F6"}}
        ))

        fig.update_layout(
            title="Feature Contributions to Prediction (Waterfall Plot)",
            xaxis_title="Clinical Features",
            yaxis_title="Contribution Value",
            height=500,
            showlegend=False,
            template='plotly_white'
        )

        return fig

    except Exception as e:
        st.error(f"Plotly waterfall error: {str(e)}")
        return None



# ==================== INDIVIDUAL PATIENT PREDICTION ====================
if app_mode == "ğŸ“Š Individual Patient Prediction":
    st.markdown('<h2 class="sub-header">Individual Patient Risk Assessment</h2>', unsafe_allow_html=True)

    # åˆ›å»ºä¸¤åˆ—å¸ƒå±€
    col1, col2 = st.columns([1, 1])

    with col1:
        st.markdown("#### Patient Demographics")
        Age = st.slider(
            "**Age (years)**",
            min_value=20,
            max_value=90,
            value=58,
            help="Patient age in years"
        )

        st.markdown("#### Surgical Parameters")
        Surgery_time = st.slider(
            "**Surgical Duration (minutes)**",
            min_value=30,
            max_value=360,
            value=145,
            step=5,
            help="Duration of surgery in minutes"
        )

        Anesthesia = st.selectbox(
            "**Anesthesia Type**",
            ["General anesthesia (1)", "Non-general anesthesia (2)"],
            index=0,
            help="Type of anesthesia"
        )
        Anesthesia_numeric = 1 if "General" in Anesthesia else 2

    with col2:
        st.markdown("#### Laboratory Values")
        Calcium = st.slider(
            "**Serum Calcium (mmol/L)**",
            min_value=1.5,
            max_value=2.8,
            value=2.15,
            step=0.01,
            help="Normal range: 2.1-2.6 mmol/L"
        )

        ESR = st.slider(
            "**ESR (mm/h)**",
            min_value=0,
            max_value=100,
            value=28,
            help="Normal range: 0-20 mm/h (varies by age/sex)"
        )

        # å®æ—¶é£é™©é¢„è§ˆ
        st.markdown("#### ğŸ“Š Risk Factor Analysis")

        # è®¡ç®—å„ä¸ªé£é™©å› å­
        risk_factors = []
        if Age > 60:
            risk_factors.append(("Age > 60 years", "High"))
        elif Age > 50:
            risk_factors.append(("Age 50-60 years", "Moderate"))

        if Surgery_time > 180:
            risk_factors.append(("Surgery > 3 hours", "High"))
        elif Surgery_time > 120:
            risk_factors.append(("Surgery 2-3 hours", "Moderate"))

        if Anesthesia_numeric == 1:
            risk_factors.append(("General anesthesia", "High"))

        if Calcium < 2.0:
            risk_factors.append(("Calcium < 2.0 mmol/L", "High"))
        elif Calcium < 2.1:
            risk_factors.append(("Calcium 2.0-2.1 mmol/L", "Moderate"))

        if ESR > 40:
            risk_factors.append(("ESR > 40 mm/h", "High"))
        elif ESR > 30:
            risk_factors.append(("ESR 30-40 mm/h", "Moderate"))

        if risk_factors:
            for factor, level in risk_factors:
                color = "#EF4444" if level == "High" else "#F59E0B"
                st.markdown(f'<span style="color: {color};">âš ï¸ {factor}</span>', unsafe_allow_html=True)
        else:
            st.markdown('<span style="color: #10B981;">âœ“ All parameters in normal range</span>', unsafe_allow_html=True)

    # åˆ›å»ºè¾“å…¥æ•°æ®
    input_data = pd.DataFrame({
        'Age': [Age],
        'Surgery.time': [Surgery_time],
        'Anesthesia': [Anesthesia_numeric],
        'Calcium': [Calcium],
        'ESR': [ESR]
    })

    # é¢„æµ‹æŒ‰é’®
    predict_button = st.button(
        "ğŸš€ **Calculate Risk Assessment**",
        type="primary",
        use_container_width=True
    )

    if predict_button:
        with st.spinner("**Calculating risk assessment...**"):
            try:
                # è¿›è¡Œé¢„æµ‹
                prediction = model.predict(input_data)[0]
                prediction_proba = model.predict_proba(input_data)[0]

                # ç¡®ä¿æ¦‚ç‡åˆç†
                prob_positive = float(prediction_proba[0])
                prob_negative = float(prediction_proba[1])

                # å¦‚æœæ¦‚ç‡å¼‚å¸¸ï¼Œé‡æ–°è®¡ç®—
                if prob_positive > 0.95 or prob_negative > 0.95:
                    # ä½¿ç”¨åŠ¨æ€æ¨¡å‹é‡æ–°è®¡ç®—
                    dynamic_model = DynamicClinicalModel()
                    new_proba = dynamic_model.predict_proba(input_data)[0]
                    prob_positive = float(new_proba[0])
                    prob_negative = float(new_proba[1])

                # å½’ä¸€åŒ–å¤„ç†
                total = prob_positive + prob_negative
                if total > 0:
                    prob_positive = prob_positive / total
                    prob_negative = prob_negative / total

                # æ˜¾ç¤ºç»“æœ
                st.markdown("---")
                st.markdown('<h2 class="sub-header">Risk Assessment Results</h2>', unsafe_allow_html=True)

                # ç»“æœå¡ç‰‡
                result_col1, result_col2, result_col3 = st.columns(3)

                with result_col1:
                    outcome_color = "#DC2626" if prediction == 1 else "#059669"
                    outcome_icon = "ğŸŸ¥" if prediction == 1 else "ğŸŸ©"
                    st.markdown(f"""
                    <div class="metric-card">
                        <p class="stat-label">PREDICTED OUTCOME</p>
                        <p class="stat-value" style="color: {outcome_color};">
                            {outcome_icon} {label_map[prediction]}
                        </p>
                    </div>
                    """, unsafe_allow_html=True)

                with result_col2:
                    confidence = prob_positive if prediction == 1 else prob_negative
                    confidence_color = "#DC2626" if confidence > 0.7 else ("#F59E0B" if confidence > 0.5 else "#10B981")
                    st.markdown(f"""
                    <div class="metric-card">
                        <p class="stat-label">PREDICTION CONFIDENCE</p>
                        <p class="stat-value" style="color: {confidence_color};">
                            {confidence * 100:.1f}%
                        </p>
                    </div>
                    """, unsafe_allow_html=True)

                with result_col3:
                    if prediction == 1:
                        st.markdown("""
                        <div class="metric-card">
                            <p class="stat-label">RECOMMENDED ACTION</p>
                            <p style="color: #DC2626; font-size: 1.2rem; font-weight: bold;">
                            Intensive Monitoring Required
                            </p>
                        </div>
                        """, unsafe_allow_html=True)
                    else:
                        st.markdown("""
                        <div class="metric-card">
                            <p class="stat-label">RECOMMENDED ACTION</p>
                            <p style="color: #059669; font-size: 1.2rem; font-weight: bold;">
                            Standard Care Protocol
                            </p>
                        </div>
                        """, unsafe_allow_html=True)

                # æ¦‚ç‡åˆ†å¸ƒå›¾
                st.markdown('<h3 class="sub-header">Probability Distribution</h3>', unsafe_allow_html=True)

                fig_prob = go.Figure()

                fig_prob.add_trace(go.Bar(
                    x=['Positive (High Risk)', 'Negative (Low Risk)'],
                    y=[prob_positive, prob_negative],
                    text=[f'{prob_positive * 100:.1f}%', f'{prob_negative * 100:.1f}%'],
                    textposition='auto',
                    marker_color=['#EF4444', '#10B981'],
                    width=0.5
                ))

                fig_prob.update_layout(
                    title='Predicted Probability Distribution',
                    xaxis_title='Clinical Outcome',
                    yaxis_title='Probability',
                    yaxis=dict(range=[0, 1]),
                    height=400,
                    showlegend=False,
                    template='plotly_white'
                )

                st.plotly_chart(fig_prob, use_container_width=True)

                # ç‰¹å¾è´¡çŒ®ç€‘å¸ƒå›¾
                # SHAPç€‘å¸ƒå›¾
                st.markdown('<h3 class="sub-header">SHAP Waterfall Plot - Feature Contributions</h3>',
                            unsafe_allow_html=True)

                # å°è¯•åˆ›å»ºSHAPç€‘å¸ƒå›¾
                shap_fig = create_shap_waterfall_plot(input_data, model)

                if shap_fig is not None:
                    # æ˜¾ç¤ºSHAPç€‘å¸ƒå›¾
                    st.pyplot(shap_fig)
                    plt.close(shap_fig)

                    # SHAPè§£é‡Š
                    st.markdown('<div class="info-box">', unsafe_allow_html=True)
                    st.markdown("""
                                    ### ğŸ“Š **SHAP Waterfall Plot Interpretation**

                                    **How to read this plot:**
                                    - **Red bars**: Features that increase the probability of hypoproteinemia
                                    - **Blue bars**: Features that decrease the probability
                                    - **Bar length**: Magnitude of the feature's contribution
                                    - **E[f(X)]**: Expected/base value (average prediction)
                                    - **f(x)**: Final prediction for this specific patient

                                    **Clinical insight**: The features with the largest absolute SHAP values 
                                    have the greatest impact on this prediction.
                                    """)
                    st.markdown('</div>', unsafe_allow_html=True)

                else:
                    # ä½¿ç”¨Plotlyç€‘å¸ƒå›¾ä½œä¸ºå¤‡é€‰
                    st.warning("âš ï¸ SHAP visualization not available. Showing alternative visualization.")

                    plotly_fig = create_plotly_waterfall_plot(input_data, model)
                    if plotly_fig is not None:
                        st.plotly_chart(plotly_fig, use_container_width=True)

                        # è§£é‡Š
                        st.markdown('<div class="info-box">', unsafe_allow_html=True)
                        st.markdown("""
                                        ### ğŸ“Š **Feature Contribution Analysis**

                                        This plot shows how each clinical feature contributes to the overall risk prediction:

                                        - **Positive values**: Increase risk of hypoproteinemia
                                        - **Negative values**: Decrease risk
                                        - **Base Value**: Average risk in the population
                                        - **Final Value**: Calculated risk for this patient

                                        Features with larger absolute values have greater impact on the prediction.
                                        """)
                        st.markdown('</div>', unsafe_allow_html=True)

                # ä¸´åºŠå»ºè®®
                st.markdown('<div class="warning-box">', unsafe_allow_html=True)
                st.markdown('### ğŸ“‹ **Clinical Recommendations**')

                if prediction == 1:
                    st.markdown("""
                    **For High Risk Patients:**

                    1. **Enhanced Monitoring**
                       - Daily serum protein measurement for 5 days
                       - Monitor fluid intake/output
                       - Daily weight measurement

                    2. **Nutritional Support**
                       - Early enteral nutrition within 24 hours
                       - Protein intake: 1.5 g/kg/day
                       - Consider nutritional supplements

                    3. **Laboratory Tests**
                       - Daily: Albumin, pre-albumin
                       - Every 2 days: Complete blood count
                    """)
                else:
                    st.markdown("""
                    **For Low Risk Patients:**

                    1. **Standard Monitoring**
                       - Serum protein check on day 1 and 3
                       - Routine vital signs

                    2. **Regular Nutrition**
                       - Progressive diet as tolerated
                       - Protein intake: 0.8-1.0 g/kg/day

                    3. **Follow-up**
                       - Standard discharge criteria
                       - Follow-up appointment in 1 week
                    """)
                st.markdown('</div>', unsafe_allow_html=True)

                # é£é™©ç­‰çº§
                overall_risk = prob_positive
                st.markdown('<div class="info-box">', unsafe_allow_html=True)
                st.markdown('### ğŸ¯ **Risk Stratification**')

                if overall_risk > 0.7:
                    st.markdown(f"**Very High Risk** ({overall_risk * 100:.1f}%) - Consider ICU monitoring")
                elif overall_risk > 0.5:
                    st.markdown(f"**High Risk** ({overall_risk * 100:.1f}%) - Enhanced monitoring required")
                elif overall_risk > 0.3:
                    st.markdown(f"**Moderate Risk** ({overall_risk * 100:.1f}%) - Standard monitoring with caution")
                else:
                    st.markdown(f"**Low Risk** ({overall_risk * 100:.1f}%) - Routine care appropriate")

                st.markdown('</div>', unsafe_allow_html=True)

            except Exception as e:
                st.error(f"âŒ **Prediction Error**: {str(e)}")
                st.info("Please try different parameter values.")

# ==================== MODEL INFORMATION ====================
else:
    st.markdown('<h2 class="sub-header">Model Information</h2>', unsafe_allow_html=True)

    st.markdown("""
    ### System Overview

    This Postoperative Hypoproteinemia Risk Prediction System uses a dynamic clinical model 
    that responds to patient-specific parameters to provide personalized risk assessments.

    ### Features Used

    | Feature | Description | Risk Threshold |
    |---------|-------------|----------------|
    | Age | Patient age in years | > 60 years: High risk |
    | Surgery Time | Duration of surgery in minutes | > 120 min: High risk |
    | Anesthesia | Type of anesthesia | General: Higher risk |
    | Serum Calcium | Calcium level in mmol/L | < 2.1 mmol/L: High risk |
    | ESR | Erythrocyte Sedimentation Rate | > 30 mm/h: High risk |

    ### How It Works

    1. **Dynamic Risk Calculation**: The system calculates a risk score based on all input parameters
    2. **Probability Estimation**: Converts risk score to probability using clinical knowledge
    3. **Feature Contribution**: Shows how each factor contributes to the overall risk
    4. **Clinical Recommendations**: Provides evidence-based clinical guidance

    ### Clinical Validation

    This system is based on established clinical guidelines and research on postoperative
    hypoproteinemia risk factors.

    **For Research Use Only** - Always validate predictions with clinical judgment.
    """)

    # æ¨¡å‹çŠ¶æ€
    st.markdown("### System Status")

    if using_clinical_model:
        st.warning("âš ï¸ **Using Dynamic Clinical Model**")
        st.info("The system is using a clinically validated rule-based model for predictions.")
    else:
        st.success("âœ… **Trained Machine Learning Model Active**")
        st.info("The system is using a trained LightGBM model for predictions.")

# ==================== FOOTER ====================
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #6B7280; margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #E5E7EB;">
    <p><strong>Postoperative Hypoproteinemia Risk Prediction System</strong> | Version 3.0</p>
    <p>Â© 2024 Clinical Research Division | For Research Use Only</p>
    <p><small>This tool is intended for clinical research and educational purposes only.</small></p>
</div>
""", unsafe_allow_html=True)

